---
title: "TimiRGeN : Time series miR-mRNA integration and Generation of Networks"
author: "Krutik Patel"
output:
        rmarkdown::html_document: 
                keep_tex: true
                toc: true
                toc_float:
                        collapsed: true
                        smooth_scroll: true
                number_sections: true
                toc_depth: 5
                fig_width: 5
                fig_heigh: 4
                fig_caption: true
                df_print: kable 
                highlight: tango
                citation_package: natbib
                self_contrained: false
                lib_dir: libs
vignette: >
        %\VignetteIndexEntry{TimiRGeN}
        %\VignetteEngine{knitr::rmarkdown}
        \usepackage[utf8]{inputenc}
---

```{r setup, include=FALSE, results='asis', warning=FALSE}
knitr::opts_chunk$set(echo = TRUE, tidy = TRUE, warning = FALSE,
message = FALSE)
options(width = 800)
```


#: Introduction
Time incorporating microRNA Generation of Networks (TimiRGeN) is aimed at 
researchers who wish to explore time series microRNA-mRNA data.
This package integrates, functionally analyses and generates small networks
which can help to generate hypothesis.

There are many microRNA (miR) and mRNA data integration and analysis packages, 
however they tend to only be capable of a few tasks necessary for analysing
this type of data. An important outcome which many of these tools do 
not achieve is reduction of the volume of data. The pipeline of this package 
takes inspiration from many of the previously published miR-mRNA integration 
tools to perform a more complete task. Furthermore, this package is made to
deal with time series miR-mRNA data which is a growing resource in biology.

To achieve data reduction without reducing biological signal, the TimiRGeN 
package utilises several published packages and employs their functions 
in a synergistic fashion for time series multi-omic analysis. The following
packages have been built upon for several functions in the TimiRGeN package:

[rWikiPathways](rWikipathway_path) [1],
[clusterProfiler](clusterProfiler_path) [2], 
[DOSE](https://bioconductor.org/packages/release/bioc/html/DOSE.html) [3],
[biomaRt](https://bioconductor.org/packages/release/bioc/html/biomaRt.html) [4],
[RCy3](https://bioconductor.org/packages/release/bioc/html/RCy3.html) [5],
[Mfuzz](https://www.bioconductor.org/packages/release/bioc/html/Mfuzz.html) [6],
[igraph](https://igraph.org/redirect.html) [7].

The pipeline which the TimiRGeN package is based on aims to reduce the 
volume of data found in time series multi-omic data sets from potentially 
millions of possible miR-mRNA interactions to a handful. The following 
miR target databases are used to achieve this:

[TargetScans](http://www.targetscan.org/vert_72/)[8].
[miRDB](http://www.mirdb.org/)[9].
[miRTarBase](http://mirtarbase.mbc.nctu.edu.tw/php/index.php)[10].

The output will be applicable for gene regulatory network (GRN) generation,
and in turn will be a foundation for further work such as:
mathematical modelling, bioinformatics exploration, a literature
search and/ or help as a resource for experimental design. 

TimiRGeN does have some capability to generate networks in R, however 
this package is uniquely open ended, as the output can be easily be
exported to [Cytoscape](https://cytoscape.org/) [11] and 
[Pathvisio](https://pathvisio.github.io/) [12] for better visualisation
options.

Furthermore, TimiRGeN solely uses wikipathways for functional pathway analysis,
and is the first tool to allow this for time series data. Wikipathways is a
user curated pathway database that contains 1000s of mechanistic 
signalling pathways of multiple species [13]. Furthermore, wikipathways works 
very well with Pathvisio which is our recommended tool for GRN exploration. 
Currently TimiRGeN only supports Human and Mouse data. 

Overall, this is an all purpose miR-mRNA integration and analysis package. It
has been made for time series data but can also accommodate conditional 
data sets. Furthermore, mRNA data can be run through by itself for functional 
analysis. Overall, the TimiRGeN package is built upon ideas from many previous 
miR-mRNA integration and several packages to deliver an open ended, 
versatile and powerful tool for multi-omic analysis.




#: Install TimiRGeN
```{r Install, eval=FALSE, message=FALSE, warning=FALSE}
if (!requireNamespace("BiocManager", quietly = TRUE))
install.packages("BiocManager")

BiocManager::install("TimiRGeN")
```


#: Load Libraries

```{r Load libs, echo=TRUE, message=FALSE, results='hide'}
libstoinst <- c("dplyr", "gtools", "rWikiPathways", "tidyr", "stringr",
"tidyverse", "clusterProfiler", "biomaRt", "org.Hs.eg.db", "org.Mm.eg.db", 
"RCy3", "ggplot2", "TimiRGeN", "igraph", "Mfuzz", "readxl", 
"MultiAssayExperiment")

lapply(libstoinst, require, character.only = TRUE)
```

The following dependencies can be investigated further from these sources
[1-7, 14-23]

```{r, echo=FALSE, warning=FALSE, error=FALSE}
library(knitr)
library(kableExtra)
```


#: Time Series microRNA-mRNA Integrated Analysis 
## Example Mouse Kidney Fribrosis Dataset
The TimiRGeN package gives the user several options for their analysis.
Currently the package can only analyse human and mouse data and can analyse miR
and mRNA data combined or separately. In this section the combined method will
be used to analyse a mouse kidney fibrosis data set. The mRNA data from
[Craciun et al (2016)](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4884105/)
[24] which was downloaded from 
[GSE65267](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE65267). The
associated miR data was published in 
[Pellegrini et al (2016)](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4912473/)
[25]
and was downloaded from
[GSE61328](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE61328). 

```{r Load Fibrosis data}
mm_miR -> miR

mm_mRNA -> mRNA
```

Notice the standard nomenclature used in the column names. Do follow the this 
standard for your own input data. The time point or should come
first and is followed by a '.'.

After the '.' the string should continue to display the specific result types 
from differential expression analysis. Note there should only be one '.' 
in each column name and no '-' characters. Having more than one '.' any '-' 
characters will confuse some functions.

Note. There should be no NAs in your miR and mRNA data files. Some
differential expression tools lead to some NAs appearing. If this is the case
please change all NA to 1, or another high number so they are removed during
downstream filtration stages of the pipeline.

## Create MultiAssayExperiment object

```{r MAE, message=FALSE}
StartObject(miR = miR, mRNA = mRNA) -> Data
```

TimiRGeN employes `MultiAssayExperiment` (MAE) to contain all the data. 
The data frames, matrices and other S4 objects are stored in `ExperimentList`,
and the lists will be stored in the `metadata`.

## Retreive Gene IDs

```{r retrieveID data for miR data, warning=FALSE, message=FALSE}
getIDs_miR_mouse(MAE = Data, miR = Data@ExperimentList$miR)  -> Data

getIDs_mRNA_mouse(MAE = Data, mRNA = Data@ExperimentList$mRNA) -> Data
```

Using `getIDs` functions the entrez gene and ensembl annotation data for genes
can be retrieved for downstream analysis. 

Many wikipathways use either entrezgene IDs or ensembl gene IDs for annotation.
Having both formats available can be useful. Also, due to the nature of miRs,
many NAs may be found in the output. Adjusted outputs can also be found
for miR data, because entrez gene IDs and ensemble gene IDs are insensitive to 
miRs with -3p and -5p strands. Therefore, slightly adjusted entrez gene IDs or
ensemble gene IDs to identify if miRs are of the -3p or -5p strand

## Filter Out Non-significant Genes

```{r CombinGenes, error=FALSE, warning=FALSE}
CombineGenes(miR_data = Data@ExperimentList$miR, mRNA_data = 
Data@ExperimentList$mRNA) -> Data@ExperimentList$genetic_data

GenesList(method = "c", genetic_data = Data@ExperimentList$genetic_data,
timeString = "D") -> Data@metadata$genelist

SignificantVals(method = "c", geneList = Data@metadata$genelist, maxVal = 0.05,
stringVal = "adjPVal") -> Data@metadata$filtered_genelist
```

mRNA and miR data can be combined using `CombineGenes` function. 

The `GenesList` function will transform the large data frame into multiple 
nested data frames within a list. The data will be separated by time.
In this example by 'D' (days), because it was before the '.'.

Significant genes can be retrieved from each nested data frame using the
`SignificantVals` function. Here only genes which had an adjusted P value of 
less than 0.05 will remain in the list.

### Find Significant Gene IDs

```{r add entrezIDs, warning=FALSE, error=FALSE}
AddIDs(method="c", 
filtered_genelist=Data@metadata$filtered_genelist, 
miR_IDs=Data@ExperimentList$miR_entrez, 
mRNA_IDs=Data@ExperimentList$mRNA_entrez)->Data@metadata$gene_entrez

eNames(method = "c", gene_IDs = Data@metadata$gene_entrez,
ID_Column = 4) -> Data@metadata$e_list 
```

Now entrez IDs or ensembl IDs which were created before can be integrated 
into our filtered data frames of genes using `AddIDs`. For this example entrez
gene IDs were be added.

Lists of entrezIDs/ ensembl IDs can be extracted for further analysis using
`eNames` function.

##Time Dependent Pathway Enrichment Method

Once we have a list of significant genes per time point we can put this through
gene set enrichment to find novel pathways which this data is associate with. 
To do this TimiRGeN uses wikipathways [13].

```{r downloadGTM, message=FALSE, warning=FALSE, eval=FALSE}
dloadGMT(MAE = Data, speciesInitials = "Mm") -> Data
```

```{r message=FALSE, warning=FALSE, echo=FALSE}
Mm_gmt@ExperimentList$path_gene -> Data@ExperimentList$path_gene
Mm_gmt@ExperimentList$path_name -> Data@ExperimentList$path_name
Mm_gmt@ExperimentList$path_data -> Data@ExperimentList$path_data
```

This is standard GSEA where we look to find which wikipathways are enriched
in our data, per time point/ condition. The `EnrichWiki` function wraps around
enrichment functions from DOSE and clusterProfiler [2,3] but uses them for
time series analysis with wikipathways.

```{r EnrichWiki, warning=FALSE, message=FALSE}
EnrichWiki(method = "c",
e_list = Data@metadata$e_list,
orgDB = org.Mm.eg.db, 
path_gene = Data@ExperimentList$path_gene, 
path_name = Data@ExperimentList$path_name, 
ID = "ENTREZID", 
universe = Data@ExperimentList$path_gene$gene) -> Data@metadata$sigwiki
```

`path_gene` and `path_name` can be found as output from the `dloadGMT` 
function. 
For a more stringent check, a user can add their own `universe` data e.g. all
possible genes in a microarray or all known genes found in a cell type.
`"ENSEMBL"` should be used if ensemble gene IDs were added to the `e_list`.

### Plot GSEA

```{r Quickbardot, warning=FALSE, message=FALSE, eval=FALSE}
SavePlots(largeList = Data@metadata$sigwiki, maxInt = 5, quickType = Quickdot, 
fileType = "jpg")
```

To plot the GSEA `Quickbar` or `Quickdot` can be used and the plots can be 
saved in a variety of different formats. 

```{r echo=FALSE, out.width = "400px",out.height= "350px", dpi=10}
knitr::include_graphics("D1_wikipathways.jpg")
knitr::include_graphics("D2_wikipathways.jpg")
```

```{r echo=FALSE, out.width = "400px", out.height="350px", dpi=10}
knitr::include_graphics("D3_wikipathways.jpg")
knitr::include_graphics("D7_wikipathways.jpg")
```

```{r echo=FALSE, out.width = "400px", out.height="350px", dpi=10}
knitr::include_graphics("D14_wikipathways.jpg")
```

From here a wikipathway can be selected for miR-mRNA interaction 
analysis. For example the Complement and Coagulation pathway.

## Temporal Pathway Clustering Method

TimiRGeN also offers a supervised soft clustering method using Mfuzz. This
aims to reduce the amount of possible pathways to look into and
direct their investigation. This provides a global view of temporal 
patterns based on the common genes found between the data at each time point 
and each wikipathway.

### Create Percent Matrix

```{r wikilist, eval=FALSE, message=FALSE, warning=FALSE}
WikiList(stringSpecies = "Mus musculus", stringSymbol = "L"
) -> Data@metadata$wlist
```

This method starts by importing all mouse wikipathways and associated gene IDs,
per mouse wikipathway. Would be 'Homo sapiens' for human data. The `L` symbol
will give us entez gene IDs and the `En` symbol will give ensembl gene IDs.

```{r wikilist_true, echo=FALSE, message=FALSE, warning=FALSE}
w_list -> Data@metadata$wlist
```

```{r Wikimatriz, message=FALSE, warning=FALSE}
WikiMatrix(e_list = Data@metadata$e_list, wp_list = Data@metadata$wlist
) -> Data@ExperimentList$Wmat
```

This Large list of genes and pathways is converted to a Matrix by `WikiMatrix`.

Now each time point from the data is represented by rows and the 
pathways are represented by columns. A user can see how many genes are common 
between  each pathway, in each time point. 

```{r Percent, message=FALSE, warning=FALSE}
TurnPercent(wikiMatrix = Data@ExperimentList$Wmat, rowInt = 6
) -> Data@metadata$Pmat
```

The final row is the total number of genes in each pathway. The `rowInt` 
parameter in the `TurnPercent` function should point to the final row in the
`Wmat`. This will account for pathway of differing sizes.

### Temporal Pathway Clustering

```{r CreateClusters, message=FALSE, warning=FALSE, fig.align ="center",dpi=80}
CreateClusters(MAE =  Data, 
method = "c", Percent_matrix = Data@metadata$Pmat,
no.clusters = 12, Variance = 0.99) -> Data
```

`CreatClusters` uses functions from Mfuzz [6] to separate the percent matrix
into a number of clusters based on temporal changes. In our example we created
12 clusters. Please refer to the Mfuzz source material for more information 
[26].

Note.The message "genes excluded" refers to wikipathways in TimiRGeN.

The standard deviation plot is from Mfuzz, this shows the variance in the 
data.

There are three output files from `CreateClusters`. 
`ClusterData` which is a Matrix displaying the respective fits of each pathway
to each cluster, and the description for each pathway. 
`Clusters` which is information needed to create downstream plots.
`Mfuzzdata` which again is required to create downstream plots. 

```{r ClusterCheck, message=FALSE, warning=FALSE, fig.align="center", dpi=80}
ClusterCheck(Clusters = Data@metadata$Clusters, W = FALSE)
```

ClusterCheck creates a PCA plot for each of the clusters. The closer the 
clusters are the more similar they are to one another. 
We can also see which time points have the most variance from one another.

### Plot Clusters

Once we are happy about the number of clusters we can plot fuzzy clusters.
The Y axis has the normalised number of genes and the X axis has the 
time points.

```{r plotfuzz, message=FALSE, eval=FALSE}
Quickfuzz(Mfuzzdata = Data@ExperimentList$MfuzzData,
Clusters = Data@metadata$Clusters, W = FALSE)
```

```{r FUZZ, echo=FALSE, out.width="800px", out.height="600px", dpi=15}
knitr::include_graphics("fuzz.jpeg")
```

The red lines represent wikipathways that fit very well in a respective 
cluster.\\
The orange lines represent wikipathways that fit well in a respective 
cluster.\\
The yellow lines represent wikipathways that somewhat fit in a respective 
cluster.\\
The purple lines represent wikipathways that partially fit in a respective 
cluster.\\

Note. After using Quickfuzz you may want to clear plots as there could be 
visual defects if one attempts to create new plots.

###Examine clusters of interest

```{r warning=FALSE, message=FALSE}
ReturnCluster(ClusterData = Data@ExperimentList$ClusterData, 
which.cluster = 12,
fit.cluster = 0.9) -> Data@ExperimentList$CLUST12_0.9
```

Finally we can extract the information of a particular cluster we may be 
interested in. For example cluster 12 has a nice dynamic where the the number
of significantly deferentially expressed genes at time points D3 and D7 peak.

####Get Pathway Information

```{r warning=FALSE, message=FALSE, eval=FALSE}
getXrefList(pathway = "WP200", "L")
getPathwayInfo("WP200")
```

Once a pathway has been identified for further analysis, rWikipathways [1]
function can be used to retrieve information. Please read the rWikipathways
documentation for more details.

## Take Selected Pathways Forward

```{r Express, warning=FALSE, message=FALSE}
Express(df = Data@ExperimentList$miR, dataType = "Log2FC",
genes_ID = Data@ExperimentList$miR_entrez, idColumn = "GENENAME"
) -> Data@ExperimentList$miRNA_log2fc

Express(df = Data@ExperimentList$mRNA, dataType = "Log2FC",
genes_ID = Data@ExperimentList$mRNA_entrez, idColumn = "GENENAME"
) -> Data@ExperimentList$mRNA_log2fc
```

The `Express` function will retrieve one specific of the differential
expression result type, along with either entrez gene IDs or ensembl gene IDs
from a `getIDs` function. It is recommend to use Log2FC or normalised 
expression values here as these values will be averaged further downstream of
the pipeline. 

The `idcolumn` refers to which column on the `miR/mRNA_entrez` or 
`miR/mRNA_ensembl` contains the gene names. If the user has not renamed the 
columns they should keep this as `GENENAME`.

### Find Genes in the Pathways of Interest and the Input mRNA Data

```{r wikimRNA, warning=FALSE, message=FALSE}
ReduceWiki(path_data =Data@ExperimentList$path_data, 
stringWiki = "Complement and Coagulation Cascades"
) -> Data@ExperimentList$Complement

WikimRNA(mRNA_express = Data@ExperimentList$mRNA_log2fc, 
SingleWiki = Data@ExperimentList$Complement
) -> Data@ExperimentList$GenesofInterest
```

A selected wikipathway can be put through `ReduceWiki` to extract the genes
which are found in this pathway. The `path_data` comes from the 
`dloadGMT` function. 

Note. Make sure the spelling of the pathway is correct. 

`WikimRNA` will find which of the genes from the selected pathway are also
found within your input data.

## Create Correlation Matrix

```{r Correlation, warning=FALSE, message=FALSE}
miR_mRNA_IntDF(miR_express = Data@ExperimentList$miRNA_log2fc,
GenesofInterest = Data@ExperimentList$GenesofInterest, 
maxInt = 5) -> Data@ExperimentList$Corr_matrix
```

`miR_mRNA_IntDF` creates a correlation matrix for every possible miR-mRNA 
interaction between the GenesofInterest and all the input miRs.

Note. There should be no NA values in the `miRNA_log2fc` data frame. 

The `maxInt` parameter must be equal the number of time points your
miR and mRNA data have.

## Download miR-mRNA Interaction Database Data

TargetScans v7.2, miRDB v6.0 and miRtarBase v7.0 [8-10] can be used to 
determine which of the potential miR-mRNA interactions have been predicted/ 
functionally tested. 
The following code will download the latest versions of the data sets
and format them for database mining.

For human analysis use `"hsa"` and `org.Hs.eg.db`.

```{r Targetscans data, message=FALSE, warning=FALSE}
dloadTargetScans() -> Data@ExperimentList$TargetScans
TargetScans_data(targetScan = Data@ExperimentList$TargetScans, species = "mmu"
) -> Data@ExperimentList$TargetScans_res
```

```{r miRDB data, message=FALSE, warning=FALSE}
dloadmiRDB() -> Data@ExperimentList$miRDB
miRDB_data(miRDB = Data@ExperimentList$miRDB, species = "mmu", 
orgDB = org.Mm.eg.db) -> Data@ExperimentList$miRDB_res
```

```{r miRtarBase data,  message=FALSE, warning=FALSE}
dloadmiRTarBase() -> Data@ExperimentList$miRTarBase
miRTarBase_data(mirtarbase = Data@ExperimentList$miRTarBase, 
species = "mmu") -> Data@ExperimentList$miRTarBase_res
```

miRTarBase is filled with a number of "functional" miR-mRNA interactions but
not all of them have the same degree of experimental scrutiny. Any evidence
type that is labelled as "weak"" has been removed so the functionally assessed 
miR-mRNA interactions can be trusted to a higher degree.

## Mine Predicted or Funtionally Assessed miR-mRNA Interactions

```{r Datamining, message=FALSE, warning=FALSE}
DataMiningMatrix(corrTable = Data@ExperimentList$Corr_matrix, 
targetscan = Data@ExperimentList$TargetScans_res, 
mirdb = Data@ExperimentList$miRDB_res,
mirtarbase = Data@ExperimentList$miRTarBase_res
) -> Data@ExperimentList$mining_matrix                    
```

The `DataMiningMatrix` will find identify if any of the potential 
interactions from the `Corr_matrix` are predicted/ functionally assessed, and 
display this as intergers.

### Filter Out miR-mRNA Interactions Based on Evidence

```{r MatrixFilter, warning=FALSE, message=FALSE}
MatrixFilter(miningMatrix = Data@ExperimentList$mining_matrix,
NegativeOnly = TRUE, THRESHOLD = 2, PredictedOnly = FALSE, maxCor = -0.5
) -> Data@ExperimentList$filt_df
```

Potential interactions with no-little evidence can be filtered out using 
parameters on `MatrixFilter`. 

`NegativeOnly` being TRUE will only filter for interactions with a negative
average correlation. 
`THRESHOLD` being 2 will filter for interactions with two or more databases 
where the interactions are identified.
`PredictedOnly` being TRUE will ignore interactions found on miRTarBase. 

## Create Internal R Networks

```{r CreateNetwork, message=FALSE, warning=FALSE, eval=FALSE}
MakeNet(filt_df = Data@ExperimentList$filt_df) -> Data@metadata$net

Quicknet(net = Data@metadata$net)
```

Utilising igraph [7] the filtered miR-mRNA interactions can be displayed. The
colour of the edges represents the level of average correlations between the
miRs and mRNAs. 

```{r netmake, echo=FALSE, dpi=8}
knitr::include_graphics("Complement.jpeg")
```

Note. Adjust size of the plot window to access the key in the bottom left 
hand side. 

Note. Having more than 15 interactions will be very difficult to see in R and
we recommend exporting to Cytoscape in these cases.

This plot can give an idea on how many interesting miR-mRNA interactions there
are in this pathway, given the input data. Based on this a user can 
continue their bioinformatics investigations by exporting this data to 
Cytoscape or Pathvisio.

## Output for Pathvisio

```{r Makestuff}
MakeDynamic(miR_expression = Data@ExperimentList$miRNA_log2fc, 
mRNA_expression = Data@ExperimentList$mRNA_log2fc, 
miR_IDs_adj = Data@ExperimentList$miR_entrez, Datatype = "L"
) -> Data@ExperimentList$Dynamics

write.csv(Data@ExperimentList$Dynamics, "Dynamics.csv", row.names = TRUE,
quote = FALSE)

MakeMapp(filt_df = Data@ExperimentList$filt_df,
miR_IDs_adj = Data@ExperimentList$miR_entrez, Datatype = "L"
) -> Data@ExperimentList$MAPP

write.table(Data@ExperimentList$MAPP, "MAPP.txt", quote = FALSE,
row.names = FALSE, col.names = FALSE, sep = "\t")
```

Filtered miR-mRNA interactions to Pathvisio [12] for better visualisation and 
GRN creation. TimiRGeN can create two types of files which can be imported by
pathvisio. Firstly, Dynamic data which can be imported as a data set to 
visualise the changes that occur to the pathway along the time course.
Next MAPP data which contains miR information can be imported into pathvisio 
via the MAPPbuilder apps. This will allow all the miRs to be imported at once.
From here some manual adjustments are necessary to create dynamic miR 
integrated signalling pathways.

Please follow the instructions in the inst/Pathvisio_GRN_guide.pdf 
for our method for GRN construction. If any ENTREZ/ ENSEMBL IDs are missing, 
it is recommended to annotate them manually in the MAPP and Dynamics
files before importing them into Pathvisio. It is recommend going through 
their tutorials for better usage of the network visualisation tool. 

This will help create a dynamic miR integrated mechanistic pathways from which
GRNs can be constructed. This is a novel data driven GRN building approach. 

Ultimately, the pipeline which the TimiRGeN package follows will allow 
a user can go from having potentially millions of miR-mRNA
interactions to a handful in a short amount of time. 

## Output for Cytoscape

```{r cytoscape, message=FALSE, warning=FALSE, eval=FALSE}
cytoscapePing()

CytoMake(interaction_data = Data@ExperimentList$filt_df,
titleString = 'Complement+Coagulation',
collectionString = 'PathwaysforKidneyFibrosis')
```

The internal R network can be exported to Cytoscape [11] by using functions
from RCy3 [5]. TimiRGeN has wrapped around several of these functions to make 
this process quicker. This will be useful if too many miR-mRNA 
interactions have been found and the internal R graphics may not do well at
handling this.

Make sure Cytoscape version 3.7 or newer is opened, 
and check for connection using `cytoscapePing()`. After this they should
feed the filtered miR-mRNA interactions data frame on the `CytoMake` function.

#: Time Series miR-mRNA Separated Analaysis

TimiRGeN also offers the option of analysing the miR and mRNA data separately. 
Many of the functions are similar but we use the `"s"` mode for some functions, 
rather than the `"c"` mode. 

##Load Data

```{r loadmouse, message=FALSE, warning=FALSE}
hs_miR -> miR
rownames(miR) <- gsub(rownames(miR), pattern = "\\.", replacement = "-")
rownames(miR) <- sub("-$", "*", rownames(miR))
hs_mRNA -> mRNA

StartObject(miR = miR, mRNA = mRNA) -> MAE

getIDs_miR_human(MAE = MAE, miR = MAE@ExperimentList$miR) -> MAE
getIDs_mRNA_human(MAE = MAE, mRNA = MAE@ExperimentList$mRNA, 
mirror = "useast") -> MAE
```

The miR data needs some more processing, this is explained further down in 
the `Working with Human Data` section..

##Differentiate Data

```{r AddPrefix, message=FALSE, warning=FALSE}
AddPrefix(gene_df = MAE@ExperimentList$miR, prefixString = "miR"
) -> MAE@ExperimentList$miR_p
AddPrefix(gene_df = MAE@ExperimentList$mRNA, prefixString = "mRNA"
) -> MAE@ExperimentList$mRNA_p
```

`AddPrefix` function will allow the miR and mRNA data to be looked at 
separately. Add a unique distinct `prefixString` to each data type
to do this.

##Find Significantly Differentially Expressed Genes per Timepoint

```{r siggenes, warning=FALSE, message=FALSE}
GenesList(method = "s",miR_data = MAE@ExperimentList$miR_p,
mRNA_data = MAE@ExperimentList$mRNA_p) -> MAE@metadata$genelist

SignificantVals(method = "s", geneList = MAE@metadata$genelist, maxVal = 0.05,
stringVal = "adjPVal") -> MAE@metadata$filtered_genelist
```

The rest of the code is very similar to the integrated analysis, except
that we use the `"s"` mode rather than the `"c"` mode for the following 
functions.

##Get Significantly Differentially Expressed Gene IDs 

```{r getensemblids, warning=FALSE, message=FALSE}
AddIDs(method="s",filtered_genelist=MAE@metadata$filtered_genelist, 
miR_IDs=MAE@ExperimentList$miR_entrez,
mRNA_IDs=MAE@ExperimentList$mRNA_entrez) -> MAE@metadata$entrez_genes 

eNames(method = "s",gene_IDs = MAE@metadata$entrez_genes,
ID_Column = 4) -> MAE@metadata$e_list
```

##WikiClustering on Separated Data

```{r echo=FALSE}
w_list_human-> MAE@metadata$w_list
```

```{r eval=FALSE}
WikiList(stringSpecies = "Homo sapiens",stringSymbol = "L"
) -> MAE@metadata$wlist 
```

```{r warning=FALSE, message=FALSE, echo=FALSE}
WikiMatrix(e_list = MAE@metadata$e_list, wp_list = MAE@metadata$w_list
) -> MAE@ExperimentList$Wmat

TurnPercent(wikiMatrix = MAE@ExperimentList$Wmat, rowInt = 7
) -> MAE@metadata$Pmat
```

###Create Clusterplot

Insert `miR` or `mRNA` as `Data_string` for CreateClusters. If another prefix
was added with `AddPrefix`, then add that.

```{r warning=FALSE, message=FALSE, eval=FALSE}
CreateClusters(method = "s", MAE = MAE, 
Percent_matrix = MAE@metadata$Pmat, no.clusters = 8, 
Data_string = "mRNA", Variance = 0.5) -> MAE

ClusterCheck(Clusters = Clusters, W = FALSE)

Quickfuzz(Mfuzzdata = MAE@ExperimentList$MfuzzData, 
Clusters = MAE@metadata$Clusters, W = FALSE)

ReturnCluster( ClusterData = MAE@ExperimentList$ClusterData, which.cluster = 3, 
fit.cluster = 0.75)) -> MAE@ExperimentList$CLUSTER3
```

## WikiEnrich Method on Separated Data

```{r eval=FALSE, message=FALSE, warning=FALSE}
dloadGMT(MAE = MAE, speciesInitials = "Hs") -> MAE

EnrichWiki(method = "s", e_list = MAE@metadata$e_list,orgDB = org.Hs.eg.db, 
path_gene = MAE@ExperimentList$path_gene, 
path_name = MAE@ExperimentList$path_name, ID = "ENTREZID", 
universe = MAE@ExperimentList$path_gene$gene) -> MAE@metadata$sigwiki
```

Note that if there are not enough pathway enrichment found the `"s"`
enrichment method will fail. This occurs often with microRNA data since not
many pathways have microRNAs within them. If this occurs, stick to `"c"` method
for miR-mRNA GSEA analysis.

#: Working with Human Data

## Example Human Breast Cancer Hypoxia Dataset

To go through this we are using Breast Cancer Hypoxia data from 
[Cramps et al (2014)](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3928101/)
[27].

##Load Data and Modify Data

```{r loadhuman, warning=FALSE, message=FALSE}
hs_miR -> miR

hs_mRNA -> mRNA
```

For TimiRGeN to work the rownames and colnames must adhere to naming 
conventions. As mentioned above the time point/ condition type
should be the first part of each column name and the result type from 
differential expression analysis e.g. Log2FC, adjPVal or AveEXP should be 
the second part of the column name. These two parts must be separated by a 
'.', which can be the only '.' in the string. 

Furthermore there should be no '_' characters in the column names. 
Acceptable names: D1.log2fc, TNFA.ajdpval, TP8.zscore ect.
Not Acceptable names: D.1.log2fc, TNFA_adjpval, TP8zscore.

Specifically for microRNAs (because naming conventions vary quite a bit), 
TimiRGeN uses it's own naming convention which must be adhered to.
A '-' should separate parts of the microRNA name e.g.
mmu-miR-140, mmu-miR-140-5p, hsa-let-7a. 

The miR data we just loaded from the breast cancer data set uses '.' 
instead of '-' in it's rownames. Depending on your own data, you may have to
tweak the nomenclature to run it through TimiRGeN.

```{r tweak, warning=FALSE, message=FALSE}
gsub(rownames(miR), pattern = "\\.", replacement =  "-") -> rownames(miR)
rownames(miR) <- sub("-$", "*", rownames(miR))
```

Some miR data will have a '.' at the end of the genenames because there are
multiple transcripts with the same name. It is best to keep these extra genes.
I prefer to replace the final '.' with a '*' symbol to make this more obvious.

##Retreive Human gene IDs

Next we retrieve ensembl or entrezIDs for our human data.
```{r gethuman, warning=FALSE, message=FALSE}
getIDs_miR_human(MAE = MAE, miR = MAE@ExperimentList$miR) -> MAE

getIDs_mRNA_human(MAE = MAE, mRNA = MAE@ExperimentList$mRNA, 
mirror = "useast") -> MAE
```

#: Converting Mouse Data to Human Data

TimiRGeN offers users the option to look into human pathways from mouse data.
Since most mammalian miR-mRNA interactions are conserved [28] this may be 
useful because there are far more curated wikipathways for humans than mouse. 


```{r loadmousetohuman, message=FALSE, warning=FALSE}
mm_miR -> miR

mm_mRNA -> mRNA

StartObject(miR = miR, mRNA = mRNA) -> MAE

getIDs_miR_mousetohuman(MAE, MAE@ExperimentList$miR, mirror = 'useast') -> MAE

getIDs_mRNA_mousetohuman(MAE, MAE@ExperimentList$mRNA, mirror = 'useast'
) -> MAE
```

All `get_IDs_mRNA` functions and `getIDs_miR_mousetohuman` relies on biomaRt
[4]. This processing power for these functions can be reduced by 
selecting a close-by biomaRt mirror. 

Converting mouse to human gene names is quite experimental. Especially for
miRNA data it should be taken with precaution. This analysis is best for 
exploratory purposes.

#: Working with Ensembl Gene IDs

TimiRGeN has the option to use EntrezIDs or Ensembl Gene ID, depending on 
the users preference. Wikipathways data is stored as entrezIDs, but many
wikipathways are curated with ensembl gene IDs. The `GMT_ensembl` function can
retrieve ensembl IDs.

```{r message=FALSE, warning=FALSE, echo=FALSE}
Mm_gmt@ExperimentList$path_gene -> MAE@ExperimentList$path_gene
Mm_gmt@ExperimentList$path_name -> MAE@ExperimentList$path_name
Mm_gmt@ExperimentList$path_data -> MAE@ExperimentList$path_data
```

```{r warning=FALSE, message=FALSE, eval=FALSE}
dloadGMT(MAE = MAE, speciesInitials = "Mm") -> MAE
```

```{r warning=FALSE, message=FALSE, eval=TRUE}
GMT_ensembl(MAE = MAE, path_gene = MAE@ExperimentList$path_gene,
path_data = MAE@ExperimentList$path_data, orgDB = org.Mm.eg.db) -> MAE
```

The new human pathways can be taken forward for analysis.

#: Analysing Only mRNA or miR Data

If only mRNA or miR data is available, this can also be put through
TimiRGeN for time course or conditional analysis. 

To do so, put your data through `"c"` mode analysis and add your `mRNA_ID` data
twice `mRNA_IDs = mRNA_entrez, miR_IDs = mRNA_entrez` in the `ADDIDs` 
function.

It is easier to run mRNA data only rather than miR data because very few 
miRs are annotated within signalling pathways.

```{r mRNAonly, warning=FALSE, message=FALSE, eval=TRUE, fig.align="center"}
mm_mRNA -> mRNA
StartObject(miR = NULL, mRNA = mRNA) -> Data
getIDs_mRNA_mouse(MAE = Data, mRNA = Data@ExperimentList$mRNA,
mirror = 'useast') -> Data

GenesList(method = 'c', genetic_data = Data@ExperimentList$mRNA,
timeString = 'D') -> Data@metadata$genelist

SignificantVals(method = 'c', geneList = Data@metadata$genelist, maxVal = 0.05, 
stringVal = 'adjPVal') -> Data@metadata$filtered_genelist

AddIDs(method='c',filtered_genelist=Data@metadata$filtered_genelist,
mRNA_IDs=Data@ExperimentList$mRNA_entrez, 
miR_IDs=Data@ExperimentList$mRNA_entrez)->Data@metadata$entrez_data

eNames(method = 'c', gene_IDs = Data@metadata$entrez_data,
ID_Column = 4) -> Data@metadata$elist
```

```{r warning=FALSE, message=FALSE, eval=FALSE, fig.align="center"}
dloadGMT(MAE = Data, speciesInitials = "Mm") -> Data
```

```{r message=FALSE, warning=FALSE, echo=FALSE}
Mm_gmt@ExperimentList$path_gene -> Data@ExperimentList$path_gene
Mm_gmt@ExperimentList$path_name -> Data@ExperimentList$path_name
Mm_gmt@ExperimentList$path_data -> Data@ExperimentList$path_data
```

```{r warning=FALSE, message=FALSE, eval=TRUE, fig.align="center"}
EnrichWiki(method = 'c', e_list = Data@metadata$elist,
orgDB = org.Mm.eg.db, path_gene = Data@ExperimentList$path_gene,
path_name = Data@ExperimentList$path_name, ID = 'ENTREZID', 
universe = Data@ExperimentList$path_gene$gene) -> Data@metadata$sigwiki
```

```{r eval=FALSE}
Quickbar(X = Data@metadata$sigwiki[[1]], Y = Data@metadata$sigwiki[1])
```

```{r fig.align="center",out.width="300px",out.height="300px",echo=FALSE,dpi=10}
knitr::include_graphics("quickbar.jpeg")
```

#References
1. Denise N Slenter et al. “WikiPathways: a multifaceted pathway database
bridging metabolomics to other omics research”. In: Nucleic acids research
46.D1 (2017), pp. D661–D667.

2. Guangchuang Yu et al. “clusterProfiler: an R package for comparing bi-
ological themes among gene clusters”. In: Omics: a journal of integrative
biology 16.5 (2012), pp. 284–287.

3. Guangchuang Yu et al. “DOSE: an R/Bioconductor package for disease
ontology semantic and enrichment analysis”. In: Bioinformatics 31.4 (2014),
pp. 608–609.

4. Damian Smedley et al. “BioMart–biological queries made easy”. In: BMC
genomics 10.1 (2009), p. 22.

5. Julia A Gustavsen et al. “RCy3: Network biology using Cytoscape from
within R”. In: F1000Research 8 (2019).

6. Lokesh Kumar and Matthias E Futschik. “Mfuzz: a software package for
soft clustering of microarray data”. In: Bioinformation 2.1 (2007), p. 5.

7. Maintainer Gabor Csardi. “Package igraph”. In: Last accessed 3.09 (2013),
p. 2013.

8. Vikram Agarwal et al. “Predicting effective microRNA target sites in
mammalian mRNAs”. In: elife 4 (2015), e05005.

9. Nathan Wong and Xiaowei Wang. “miRDB: an online resource for mi-
croRNA target prediction and functional annotations”. In: Nucleic acids
research 43.D1 (2014), pp. D146–D152.

10. Chih-Hung Chou et al. “miRTarBase update 2018: a resource for exper-
imentally validated microRNA-target interactions”. In: Nucleic acids re-
search 46.D1 (2017), pp. D296–D302.

11. Michael E Smoot et al. “Cytoscape 2.8: new features for data integration
and network visualization”. In: Bioinformatics 27.3 (2010), pp. 431–432.

12. Martijn P van Iersel et al. “Presenting and exploring biological pathways
with PathVisio”. In: BMC bioinformatics 9.1 (2008), p. 399.

13. Alexander R Pico et al. “WikiPathways: pathway editing for the people”.
In: PLoS biology 6.7 (2008), e184.

14. Hadley Wickham et al. “dplyr: a grammar of data manipulation, 2013”.
In: URL https://github. com/hadley/dplyr. version 0.1.[p 1] (2017).

15. Gregory R Warnes, Ben Bolker, and Thomas Lumley. “gtools: Various R
programming tools”. In: R package version 3.1 (2014).

16. Hadley Wickham and Lionel Henry. “Tidyr: Easily tidy data withspread
()andgather ()functions”. In: R package version 0.6 1 (2017).

17. Hadley Wickham. “stringr: Make it easier to work with strings”. In: R
package version 0.6 2 (2012), pp. 96–7.

18. Hadley Wickham. “The tidyverse”. In: R package ver. 1.1 1 (2017).

19. Hadley Wickham. ggplot2: elegant graphics for data analysis. Springer 2016.

20. Carlson M (2019). org.Hs.eg.db: Genome wide annotation for Human. R package
version 3.8.2.

21. Carlson M (2019). org.Mmu.eg.db: Genome wide annotation for Rhesus. R
package version 3.8.2.

22. Claus Thorn Ekstrom. R Primer. Chapman and Hall/CRC, 2019.

23. Ramos M, Schiffer L, Re A, Azhar R, Basunia A, Cabrera CR, Chan T, Chapman
P, Davis S, Gomez-Cabrero D, Culhane AC, Haibe-Kains B, Hansen K, Kodali H, 
Louis MS, Mer AS, Reister M, Morgan M, Carey V, Waldron L (2017). “
Software For The Integration Of Multi-Omics Experiments In Bioconductor.” 
Cancer Research, 77(21); e39-42.

24. Florin L Craciun et al. “RNA sequencing identifies novel translational
biomarkers of kidney fibrosis”. In: Journal of the American Society of
Nephrology 27.6 (2016), pp. 1702–1713.

25. Kathryn L Pellegrini et al. “Application of small RNA sequencing to iden-
tify microRNAs in acute kidney injury and fibrosis”. In: Toxicology and
applied pharmacology 312 (2016), pp. 42–52.

26. Matthias E Futschik and Lokesh Kumar. “Introduction to Mfuzz package
and its graphical user interface”. In: (2013).

27. Carme Camps et al. “Integrated analysis of microRNA and mRNA expres-
sion and association with HIF binding reveals the complexity of microRNA
expression regulation under hypoxia”. In: Molecular cancer 13.1 (2014),
p. 28.

28. Maria Warnefors et al. “Conserved microRNA editing in mammalian evo-
lution, development and disease”. In: Genome biology 15.6 (2014), R83.
